import{T as kt,a as Ce,b as ut,L as Dt,c as re,F as lt,M as G,V as we,C as Z,d as V,S as oe,e as Ct,P as Nt,D as dt,f as Te,g as W,I as Ot,Q as ht,h as Pt,O as ae,i as Ft,j as Ht,B as _e,k as Bt,l as ft,N as Gt,m as jt,n as Ut,o as Ne,p as pt,R as Oe,q as Kt,r as Vt,s as qt,t as Me,u as Xt,v as mt,w as Wt,x as Y,y as Yt,z as zt,A as Qt,E as Ee,G as $t,H as Zt,J as Jt,K as es,U as Ie,W as gt,X as ts,Y as ss,Z as ns,_ as rs,$ as is,a0 as os,a1 as Tt,a2 as as,a3 as Xe,a4 as We,a5 as Ye,a6 as ze,a7 as Qe,a8 as cs,a9 as us,aa as Ge,ab as ls,ac as je,ad as ds,ae as hs,af as fs}from"./three-CTTdVYl2.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();function $e(n,e){if(e===kt)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),n;if(e===Ce||e===ut){let t=n.getIndex();if(t===null){const o=[],c=n.getAttribute("position");if(c!==void 0){for(let a=0;a<c.count;a++)o.push(a);n.setIndex(o),t=n.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),n}const r=t.count-2,s=[];if(e===Ce)for(let o=1;o<=r;o++)s.push(t.getX(0)),s.push(t.getX(o)),s.push(t.getX(o+1));else for(let o=0;o<r;o++)o%2===0?(s.push(t.getX(o)),s.push(t.getX(o+1)),s.push(t.getX(o+2))):(s.push(t.getX(o+2)),s.push(t.getX(o+1)),s.push(t.getX(o)));s.length/3!==r&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const i=n.clone();return i.setIndex(s),i.clearGroups(),i}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),n}class ps extends Dt{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new ys(t)}),this.register(function(t){return new xs(t)}),this.register(function(t){return new Ls(t)}),this.register(function(t){return new vs(t)}),this.register(function(t){return new ks(t)}),this.register(function(t){return new Es(t)}),this.register(function(t){return new Ss(t)}),this.register(function(t){return new Rs(t)}),this.register(function(t){return new bs(t)}),this.register(function(t){return new As(t)}),this.register(function(t){return new _s(t)}),this.register(function(t){return new ws(t)}),this.register(function(t){return new Is(t)}),this.register(function(t){return new Ms(t)}),this.register(function(t){return new gs(t)}),this.register(function(t){return new Ds(t)}),this.register(function(t){return new Cs(t)})}load(e,t,r,s){const i=this;let o;if(this.resourcePath!=="")o=this.resourcePath;else if(this.path!==""){const u=re.extractUrlBase(e);o=re.resolveURL(u,this.path)}else o=re.extractUrlBase(e);this.manager.itemStart(e);const c=function(u){s?s(u):console.error(u),i.manager.itemError(e),i.manager.itemEnd(e)},a=new lt(this.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.setRequestHeader(this.requestHeader),a.setWithCredentials(this.withCredentials),a.load(e,function(u){try{i.parse(u,o,function(l){t(l),i.manager.itemEnd(e)},c)}catch(l){c(l)}},r,c)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,r,s){let i;const o={},c={},a=new TextDecoder;if(typeof e=="string")i=JSON.parse(e);else if(e instanceof ArrayBuffer)if(a.decode(new Uint8Array(e,0,4))===At){try{o[w.KHR_BINARY_GLTF]=new Ns(e)}catch(d){s&&s(d);return}i=JSON.parse(o[w.KHR_BINARY_GLTF].content)}else i=JSON.parse(a.decode(e));else i=e;if(i.asset===void 0||i.asset.version[0]<2){s&&s(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const u=new Ws(i,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});u.fileLoader.setRequestHeader(this.requestHeader);for(let l=0;l<this.pluginCallbacks.length;l++){const d=this.pluginCallbacks[l](u);d.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),c[d.name]=d,o[d.name]=!0}if(i.extensionsUsed)for(let l=0;l<i.extensionsUsed.length;++l){const d=i.extensionsUsed[l],f=i.extensionsRequired||[];switch(d){case w.KHR_MATERIALS_UNLIT:o[d]=new Ts;break;case w.KHR_DRACO_MESH_COMPRESSION:o[d]=new Os(i,this.dracoLoader);break;case w.KHR_TEXTURE_TRANSFORM:o[d]=new Ps;break;case w.KHR_MESH_QUANTIZATION:o[d]=new Fs;break;default:f.indexOf(d)>=0&&c[d]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+d+'".')}}u.setExtensions(o),u.setPlugins(c),u.parse(r,s)}parseAsync(e,t){const r=this;return new Promise(function(s,i){r.parse(e,t,s,i)})}}function ms(){let n={};return{get:function(e){return n[e]},add:function(e,t){n[e]=t},remove:function(e){delete n[e]},removeAll:function(){n={}}}}const w={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class gs{constructor(e){this.parser=e,this.name=w.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let r=0,s=t.length;r<s;r++){const i=t[r];i.extensions&&i.extensions[this.name]&&i.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){const t=this.parser,r="light:"+e;let s=t.cache.get(r);if(s)return s;const i=t.json,a=((i.extensions&&i.extensions[this.name]||{}).lights||[])[e];let u;const l=new Z(16777215);a.color!==void 0&&l.setRGB(a.color[0],a.color[1],a.color[2],V);const d=a.range!==void 0?a.range:0;switch(a.type){case"directional":u=new dt(l),u.target.position.set(0,0,-1),u.add(u.target);break;case"point":u=new Nt(l),u.distance=d;break;case"spot":u=new Ct(l),u.distance=d,a.spot=a.spot||{},a.spot.innerConeAngle=a.spot.innerConeAngle!==void 0?a.spot.innerConeAngle:0,a.spot.outerConeAngle=a.spot.outerConeAngle!==void 0?a.spot.outerConeAngle:Math.PI/4,u.angle=a.spot.outerConeAngle,u.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,u.target.position.set(0,0,-1),u.add(u.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return u.position.set(0,0,0),j(u,a),a.intensity!==void 0&&(u.intensity=a.intensity),u.name=t.createUniqueName(a.name||"light_"+e),s=Promise.resolve(u),t.cache.add(r,s),s}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,r=this.parser,i=r.json.nodes[e],c=(i.extensions&&i.extensions[this.name]||{}).light;return c===void 0?null:this._loadLight(c).then(function(a){return r._getNodeRef(t.cache,c,a)})}}class Ts{constructor(){this.name=w.KHR_MATERIALS_UNLIT}getMaterialType(){return Y}extendParams(e,t,r){const s=[];e.color=new Z(1,1,1),e.opacity=1;const i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const o=i.baseColorFactor;e.color.setRGB(o[0],o[1],o[2],V),e.opacity=o[3]}i.baseColorTexture!==void 0&&s.push(r.assignTexture(e,"map",i.baseColorTexture,oe))}return Promise.all(s)}}class As{constructor(e){this.parser=e,this.name=w.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name].emissiveStrength;return i!==void 0&&(t.emissiveIntensity=i),Promise.resolve()}}class ys{constructor(e){this.parser=e,this.name=w.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:G}extendMaterialParams(e,t){const r=this.parser,s=r.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];if(o.clearcoatFactor!==void 0&&(t.clearcoat=o.clearcoatFactor),o.clearcoatTexture!==void 0&&i.push(r.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),o.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),o.clearcoatRoughnessTexture!==void 0&&i.push(r.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),o.clearcoatNormalTexture!==void 0&&(i.push(r.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),o.clearcoatNormalTexture.scale!==void 0)){const c=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new we(c,c)}return Promise.all(i)}}class xs{constructor(e){this.parser=e,this.name=w.KHR_MATERIALS_DISPERSION}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:G}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name];return t.dispersion=i.dispersion!==void 0?i.dispersion:0,Promise.resolve()}}class ws{constructor(e){this.parser=e,this.name=w.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:G}extendMaterialParams(e,t){const r=this.parser,s=r.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];return o.iridescenceFactor!==void 0&&(t.iridescence=o.iridescenceFactor),o.iridescenceTexture!==void 0&&i.push(r.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),o.iridescenceIor!==void 0&&(t.iridescenceIOR=o.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),o.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),o.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),o.iridescenceThicknessTexture!==void 0&&i.push(r.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(i)}}class Es{constructor(e){this.parser=e,this.name=w.KHR_MATERIALS_SHEEN}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:G}extendMaterialParams(e,t){const r=this.parser,s=r.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[];t.sheenColor=new Z(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=s.extensions[this.name];if(o.sheenColorFactor!==void 0){const c=o.sheenColorFactor;t.sheenColor.setRGB(c[0],c[1],c[2],V)}return o.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=o.sheenRoughnessFactor),o.sheenColorTexture!==void 0&&i.push(r.assignTexture(t,"sheenColorMap",o.sheenColorTexture,oe)),o.sheenRoughnessTexture!==void 0&&i.push(r.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(i)}}class Ss{constructor(e){this.parser=e,this.name=w.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:G}extendMaterialParams(e,t){const r=this.parser,s=r.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];return o.transmissionFactor!==void 0&&(t.transmission=o.transmissionFactor),o.transmissionTexture!==void 0&&i.push(r.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(i)}}class Rs{constructor(e){this.parser=e,this.name=w.KHR_MATERIALS_VOLUME}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:G}extendMaterialParams(e,t){const r=this.parser,s=r.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];t.thickness=o.thicknessFactor!==void 0?o.thicknessFactor:0,o.thicknessTexture!==void 0&&i.push(r.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const c=o.attenuationColor||[1,1,1];return t.attenuationColor=new Z().setRGB(c[0],c[1],c[2],V),Promise.all(i)}}class bs{constructor(e){this.parser=e,this.name=w.KHR_MATERIALS_IOR}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:G}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name];return t.ior=i.ior!==void 0?i.ior:1.5,Promise.resolve()}}class _s{constructor(e){this.parser=e,this.name=w.KHR_MATERIALS_SPECULAR}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:G}extendMaterialParams(e,t){const r=this.parser,s=r.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];t.specularIntensity=o.specularFactor!==void 0?o.specularFactor:1,o.specularTexture!==void 0&&i.push(r.assignTexture(t,"specularIntensityMap",o.specularTexture));const c=o.specularColorFactor||[1,1,1];return t.specularColor=new Z().setRGB(c[0],c[1],c[2],V),o.specularColorTexture!==void 0&&i.push(r.assignTexture(t,"specularColorMap",o.specularColorTexture,oe)),Promise.all(i)}}class Ms{constructor(e){this.parser=e,this.name=w.EXT_MATERIALS_BUMP}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:G}extendMaterialParams(e,t){const r=this.parser,s=r.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];return t.bumpScale=o.bumpFactor!==void 0?o.bumpFactor:1,o.bumpTexture!==void 0&&i.push(r.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(i)}}class Is{constructor(e){this.parser=e,this.name=w.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const r=this.parser.json.materials[e];return!r.extensions||!r.extensions[this.name]?null:G}extendMaterialParams(e,t){const r=this.parser,s=r.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=[],o=s.extensions[this.name];return o.anisotropyStrength!==void 0&&(t.anisotropy=o.anisotropyStrength),o.anisotropyRotation!==void 0&&(t.anisotropyRotation=o.anisotropyRotation),o.anisotropyTexture!==void 0&&i.push(r.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(i)}}class Ls{constructor(e){this.parser=e,this.name=w.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,r=t.json,s=r.textures[e];if(!s.extensions||!s.extensions[this.name])return null;const i=s.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(r.extensionsRequired&&r.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,i.source,o)}}class vs{constructor(e){this.parser=e,this.name=w.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,r=this.parser,s=r.json,i=s.textures[e];if(!i.extensions||!i.extensions[t])return null;const o=i.extensions[t],c=s.images[o.source];let a=r.textureLoader;if(c.uri){const u=r.options.manager.getHandler(c.uri);u!==null&&(a=u)}return this.detectSupport().then(function(u){if(u)return r.loadTextureImage(e,o.source,a);if(s.extensionsRequired&&s.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return r.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class ks{constructor(e){this.parser=e,this.name=w.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,r=this.parser,s=r.json,i=s.textures[e];if(!i.extensions||!i.extensions[t])return null;const o=i.extensions[t],c=s.images[o.source];let a=r.textureLoader;if(c.uri){const u=r.options.manager.getHandler(c.uri);u!==null&&(a=u)}return this.detectSupport().then(function(u){if(u)return r.loadTextureImage(e,o.source,a);if(s.extensionsRequired&&s.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return r.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Ds{constructor(e){this.name=w.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,r=t.bufferViews[e];if(r.extensions&&r.extensions[this.name]){const s=r.extensions[this.name],i=this.parser.getDependency("buffer",s.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return i.then(function(c){const a=s.byteOffset||0,u=s.byteLength||0,l=s.count,d=s.byteStride,f=new Uint8Array(c,a,u);return o.decodeGltfBufferAsync?o.decodeGltfBufferAsync(l,d,f,s.mode,s.filter).then(function(h){return h.buffer}):o.ready.then(function(){const h=new ArrayBuffer(l*d);return o.decodeGltfBuffer(new Uint8Array(h),l,d,f,s.mode,s.filter),h})})}else return null}}class Cs{constructor(e){this.name=w.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,r=t.nodes[e];if(!r.extensions||!r.extensions[this.name]||r.mesh===void 0)return null;const s=t.meshes[r.mesh];for(const u of s.primitives)if(u.mode!==k.TRIANGLES&&u.mode!==k.TRIANGLE_STRIP&&u.mode!==k.TRIANGLE_FAN&&u.mode!==void 0)return null;const o=r.extensions[this.name].attributes,c=[],a={};for(const u in o)c.push(this.parser.getDependency("accessor",o[u]).then(l=>(a[u]=l,a[u])));return c.length<1?null:(c.push(this.parser.createNodeMesh(e)),Promise.all(c).then(u=>{const l=u.pop(),d=l.isGroup?l.children:[l],f=u[0].count,h=[];for(const p of d){const m=new Te,g=new W,T=new ht,A=new W(1,1,1),E=new Ot(p.geometry,p.material,f);for(let x=0;x<f;x++)a.TRANSLATION&&g.fromBufferAttribute(a.TRANSLATION,x),a.ROTATION&&T.fromBufferAttribute(a.ROTATION,x),a.SCALE&&A.fromBufferAttribute(a.SCALE,x),E.setMatrixAt(x,m.compose(g,T,A));for(const x in a)if(x==="_COLOR_0"){const _=a[x];E.instanceColor=new Pt(_.array,_.itemSize,_.normalized)}else x!=="TRANSLATION"&&x!=="ROTATION"&&x!=="SCALE"&&p.geometry.setAttribute(x,a[x]);ae.prototype.copy.call(E,p),this.parser.assignFinalMaterial(E),h.push(E)}return l.isGroup?(l.clear(),l.add(...h),l):h[0]}))}}const At="glTF",ne=12,Ze={JSON:1313821514,BIN:5130562};class Ns{constructor(e){this.name=w.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,ne),r=new TextDecoder;if(this.header={magic:r.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==At)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const s=this.header.length-ne,i=new DataView(e,ne);let o=0;for(;o<s;){const c=i.getUint32(o,!0);o+=4;const a=i.getUint32(o,!0);if(o+=4,a===Ze.JSON){const u=new Uint8Array(e,ne+o,c);this.content=r.decode(u)}else if(a===Ze.BIN){const u=ne+o;this.body=e.slice(u,u+c)}o+=c}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Os{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=w.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const r=this.json,s=this.dracoLoader,i=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,c={},a={},u={};for(const l in o){const d=Pe[l]||l.toLowerCase();c[d]=o[l]}for(const l in e.attributes){const d=Pe[l]||l.toLowerCase();if(o[l]!==void 0){const f=r.accessors[e.attributes[l]],h=ee[f.componentType];u[d]=h.name,a[d]=f.normalized===!0}}return t.getDependency("bufferView",i).then(function(l){return new Promise(function(d,f){s.decodeDracoFile(l,function(h){for(const p in h.attributes){const m=h.attributes[p],g=a[p];g!==void 0&&(m.normalized=g)}d(h)},c,u,V,f)})})}}class Ps{constructor(){this.name=w.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Fs{constructor(){this.name=w.KHR_MESH_QUANTIZATION}}class yt extends us{constructor(e,t,r,s){super(e,t,r,s)}copySampleValue_(e){const t=this.resultBuffer,r=this.sampleValues,s=this.valueSize,i=e*s*3+s;for(let o=0;o!==s;o++)t[o]=r[i+o];return t}interpolate_(e,t,r,s){const i=this.resultBuffer,o=this.sampleValues,c=this.valueSize,a=c*2,u=c*3,l=s-t,d=(r-t)/l,f=d*d,h=f*d,p=e*u,m=p-u,g=-2*h+3*f,T=h-f,A=1-g,E=T-f+d;for(let x=0;x!==c;x++){const _=o[m+x+c],D=o[m+x+a]*l,M=o[p+x+c],se=o[p+x]*l;i[x]=A*_+E*D+g*M+T*se}return i}}const Hs=new ht;class Bs extends yt{interpolate_(e,t,r,s){const i=super.interpolate_(e,t,r,s);return Hs.fromArray(i).normalize().toArray(i),i}}const k={POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6},ee={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Je={9728:pt,9729:Ne,9984:Ut,9985:jt,9986:Gt,9987:ft},et={33071:Vt,33648:Kt,10497:Oe},Le={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Pe={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},X={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Gs={CUBICSPLINE:void 0,LINEAR:Tt,STEP:os},ve={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function js(n){return n.DefaultMaterial===void 0&&(n.DefaultMaterial=new mt({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:cs})),n.DefaultMaterial}function z(n,e,t){for(const r in t.extensions)n[r]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[r]=t.extensions[r])}function j(n,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(n.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function Us(n,e,t){let r=!1,s=!1,i=!1;for(let u=0,l=e.length;u<l;u++){const d=e[u];if(d.POSITION!==void 0&&(r=!0),d.NORMAL!==void 0&&(s=!0),d.COLOR_0!==void 0&&(i=!0),r&&s&&i)break}if(!r&&!s&&!i)return Promise.resolve(n);const o=[],c=[],a=[];for(let u=0,l=e.length;u<l;u++){const d=e[u];if(r){const f=d.POSITION!==void 0?t.getDependency("accessor",d.POSITION):n.attributes.position;o.push(f)}if(s){const f=d.NORMAL!==void 0?t.getDependency("accessor",d.NORMAL):n.attributes.normal;c.push(f)}if(i){const f=d.COLOR_0!==void 0?t.getDependency("accessor",d.COLOR_0):n.attributes.color;a.push(f)}}return Promise.all([Promise.all(o),Promise.all(c),Promise.all(a)]).then(function(u){const l=u[0],d=u[1],f=u[2];return r&&(n.morphAttributes.position=l),s&&(n.morphAttributes.normal=d),i&&(n.morphAttributes.color=f),n.morphTargetsRelative=!0,n})}function Ks(n,e){if(n.updateMorphTargets(),e.weights!==void 0)for(let t=0,r=e.weights.length;t<r;t++)n.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(n.morphTargetInfluences.length===t.length){n.morphTargetDictionary={};for(let r=0,s=t.length;r<s;r++)n.morphTargetDictionary[t[r]]=r}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Vs(n){let e;const t=n.extensions&&n.extensions[w.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+ke(t.attributes):e=n.indices+":"+ke(n.attributes)+":"+n.mode,n.targets!==void 0)for(let r=0,s=n.targets.length;r<s;r++)e+=":"+ke(n.targets[r]);return e}function ke(n){let e="";const t=Object.keys(n).sort();for(let r=0,s=t.length;r<s;r++)e+=t[r]+":"+n[t[r]]+";";return e}function Fe(n){switch(n){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function qs(n){return n.search(/\.jpe?g($|\?)/i)>0||n.search(/^data\:image\/jpeg/)===0?"image/jpeg":n.search(/\.webp($|\?)/i)>0||n.search(/^data\:image\/webp/)===0?"image/webp":n.search(/\.ktx2($|\?)/i)>0||n.search(/^data\:image\/ktx2/)===0?"image/ktx2":"image/png"}const Xs=new Te;class Ws{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new ms,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let r=!1,s=-1,i=!1,o=-1;if(typeof navigator<"u"){const c=navigator.userAgent;r=/^((?!chrome|android).)*safari/i.test(c)===!0;const a=c.match(/Version\/(\d+)/);s=r&&a?parseInt(a[1],10):-1,i=c.indexOf("Firefox")>-1,o=i?c.match(/Firefox\/([0-9]+)\./)[1]:-1}typeof createImageBitmap>"u"||r&&s<17||i&&o<98?this.textureLoader=new Ft(this.options.manager):this.textureLoader=new Ht(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new lt(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const r=this,s=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(o){return o._markDefs&&o._markDefs()}),Promise.all(this._invokeAll(function(o){return o.beforeRoot&&o.beforeRoot()})).then(function(){return Promise.all([r.getDependencies("scene"),r.getDependencies("animation"),r.getDependencies("camera")])}).then(function(o){const c={scene:o[0][s.scene||0],scenes:o[0],animations:o[1],cameras:o[2],asset:s.asset,parser:r,userData:{}};return z(i,c,s),j(c,s),Promise.all(r._invokeAll(function(a){return a.afterRoot&&a.afterRoot(c)})).then(function(){for(const a of c.scenes)a.updateMatrixWorld();e(c)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[];for(let s=0,i=t.length;s<i;s++){const o=t[s].joints;for(let c=0,a=o.length;c<a;c++)e[o[c]].isBone=!0}for(let s=0,i=e.length;s<i;s++){const o=e[s];o.mesh!==void 0&&(this._addNodeRef(this.meshCache,o.mesh),o.skin!==void 0&&(r[o.mesh].isSkinnedMesh=!0)),o.camera!==void 0&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,r){if(e.refs[t]<=1)return r;const s=r.clone(),i=(o,c)=>{const a=this.associations.get(o);a!=null&&this.associations.set(c,a);for(const[u,l]of o.children.entries())i(l,c.children[u])};return i(r,s),s.name+="_instance_"+e.uses[t]++,s}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let r=0;r<t.length;r++){const s=e(t[r]);if(s)return s}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const r=[];for(let s=0;s<t.length;s++){const i=e(t[s]);i&&r.push(i)}return r}getDependency(e,t){const r=e+":"+t;let s=this.cache.get(r);if(!s){switch(e){case"scene":s=this.loadScene(t);break;case"node":s=this._invokeOne(function(i){return i.loadNode&&i.loadNode(t)});break;case"mesh":s=this._invokeOne(function(i){return i.loadMesh&&i.loadMesh(t)});break;case"accessor":s=this.loadAccessor(t);break;case"bufferView":s=this._invokeOne(function(i){return i.loadBufferView&&i.loadBufferView(t)});break;case"buffer":s=this.loadBuffer(t);break;case"material":s=this._invokeOne(function(i){return i.loadMaterial&&i.loadMaterial(t)});break;case"texture":s=this._invokeOne(function(i){return i.loadTexture&&i.loadTexture(t)});break;case"skin":s=this.loadSkin(t);break;case"animation":s=this._invokeOne(function(i){return i.loadAnimation&&i.loadAnimation(t)});break;case"camera":s=this.loadCamera(t);break;default:if(s=this._invokeOne(function(i){return i!=this&&i.getDependency&&i.getDependency(e,t)}),!s)throw new Error("Unknown type: "+e);break}this.cache.add(r,s)}return s}getDependencies(e){let t=this.cache.get(e);if(!t){const r=this,s=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(s.map(function(i,o){return r.getDependency(e,o)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],r=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[w.KHR_BINARY_GLTF].body);const s=this.options;return new Promise(function(i,o){r.load(re.resolveURL(t.uri,s.path),i,void 0,function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(r){const s=t.byteLength||0,i=t.byteOffset||0;return r.slice(i,i+s)})}loadAccessor(e){const t=this,r=this.json,s=this.json.accessors[e];if(s.bufferView===void 0&&s.sparse===void 0){const o=Le[s.type],c=ee[s.componentType],a=s.normalized===!0,u=new c(s.count*o);return Promise.resolve(new _e(u,o,a))}const i=[];return s.bufferView!==void 0?i.push(this.getDependency("bufferView",s.bufferView)):i.push(null),s.sparse!==void 0&&(i.push(this.getDependency("bufferView",s.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",s.sparse.values.bufferView))),Promise.all(i).then(function(o){const c=o[0],a=Le[s.type],u=ee[s.componentType],l=u.BYTES_PER_ELEMENT,d=l*a,f=s.byteOffset||0,h=s.bufferView!==void 0?r.bufferViews[s.bufferView].byteStride:void 0,p=s.normalized===!0;let m,g;if(h&&h!==d){const T=Math.floor(f/h),A="InterleavedBuffer:"+s.bufferView+":"+s.componentType+":"+T+":"+s.count;let E=t.cache.get(A);E||(m=new u(c,T*h,s.count*h/l),E=new Bt(m,h/l),t.cache.add(A,E)),g=new as(E,a,f%h/l,p)}else c===null?m=new u(s.count*a):m=new u(c,f,s.count*a),g=new _e(m,a,p);if(s.sparse!==void 0){const T=Le.SCALAR,A=ee[s.sparse.indices.componentType],E=s.sparse.indices.byteOffset||0,x=s.sparse.values.byteOffset||0,_=new A(o[1],E,s.sparse.count*T),D=new u(o[2],x,s.sparse.count*a);c!==null&&(g=new _e(g.array.slice(),g.itemSize,g.normalized)),g.normalized=!1;for(let M=0,se=_.length;M<se;M++){const q=_[M];if(g.setX(q,D[M*a]),a>=2&&g.setY(q,D[M*a+1]),a>=3&&g.setZ(q,D[M*a+2]),a>=4&&g.setW(q,D[M*a+3]),a>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}g.normalized=p}return g})}loadTexture(e){const t=this.json,r=this.options,i=t.textures[e].source,o=t.images[i];let c=this.textureLoader;if(o.uri){const a=r.manager.getHandler(o.uri);a!==null&&(c=a)}return this.loadTextureImage(e,i,c)}loadTextureImage(e,t,r){const s=this,i=this.json,o=i.textures[e],c=i.images[t],a=(c.uri||c.bufferView)+":"+o.sampler;if(this.textureCache[a])return this.textureCache[a];const u=this.loadImageSource(t,r).then(function(l){l.flipY=!1,l.name=o.name||c.name||"",l.name===""&&typeof c.uri=="string"&&c.uri.startsWith("data:image/")===!1&&(l.name=c.uri);const f=(i.samplers||{})[o.sampler]||{};return l.magFilter=Je[f.magFilter]||Ne,l.minFilter=Je[f.minFilter]||ft,l.wrapS=et[f.wrapS]||Oe,l.wrapT=et[f.wrapT]||Oe,l.generateMipmaps=!l.isCompressedTexture&&l.minFilter!==pt&&l.minFilter!==Ne,s.associations.set(l,{textures:e}),l}).catch(function(){return null});return this.textureCache[a]=u,u}loadImageSource(e,t){const r=this,s=this.json,i=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(d=>d.clone());const o=s.images[e],c=self.URL||self.webkitURL;let a=o.uri||"",u=!1;if(o.bufferView!==void 0)a=r.getDependency("bufferView",o.bufferView).then(function(d){u=!0;const f=new Blob([d],{type:o.mimeType});return a=c.createObjectURL(f),a});else if(o.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const l=Promise.resolve(a).then(function(d){return new Promise(function(f,h){let p=f;t.isImageBitmapLoader===!0&&(p=function(m){const g=new Xe(m);g.needsUpdate=!0,f(g)}),t.load(re.resolveURL(d,i.path),p,void 0,h)})}).then(function(d){return u===!0&&c.revokeObjectURL(a),j(d,o),d.userData.mimeType=o.mimeType||qs(o.uri),d}).catch(function(d){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),d});return this.sourceCache[e]=l,l}assignTexture(e,t,r,s){const i=this;return this.getDependency("texture",r.index).then(function(o){if(!o)return null;if(r.texCoord!==void 0&&r.texCoord>0&&(o=o.clone(),o.channel=r.texCoord),i.extensions[w.KHR_TEXTURE_TRANSFORM]){const c=r.extensions!==void 0?r.extensions[w.KHR_TEXTURE_TRANSFORM]:void 0;if(c){const a=i.associations.get(o);o=i.extensions[w.KHR_TEXTURE_TRANSFORM].extendTexture(o,c),i.associations.set(o,a)}}return s!==void 0&&(o.colorSpace=s),e[t]=o,o})}assignFinalMaterial(e){const t=e.geometry;let r=e.material;const s=t.attributes.tangent===void 0,i=t.attributes.color!==void 0,o=t.attributes.normal===void 0;if(e.isPoints){const c="PointsMaterial:"+r.uuid;let a=this.cache.get(c);a||(a=new qt,Me.prototype.copy.call(a,r),a.color.copy(r.color),a.map=r.map,a.sizeAttenuation=!1,this.cache.add(c,a)),r=a}else if(e.isLine){const c="LineBasicMaterial:"+r.uuid;let a=this.cache.get(c);a||(a=new Xt,Me.prototype.copy.call(a,r),a.color.copy(r.color),a.map=r.map,this.cache.add(c,a)),r=a}if(s||i||o){let c="ClonedMaterial:"+r.uuid+":";s&&(c+="derivative-tangents:"),i&&(c+="vertex-colors:"),o&&(c+="flat-shading:");let a=this.cache.get(c);a||(a=r.clone(),i&&(a.vertexColors=!0),o&&(a.flatShading=!0),s&&(a.normalScale&&(a.normalScale.y*=-1),a.clearcoatNormalScale&&(a.clearcoatNormalScale.y*=-1)),this.cache.add(c,a),this.associations.set(a,this.associations.get(r))),r=a}e.material=r}getMaterialType(){return mt}loadMaterial(e){const t=this,r=this.json,s=this.extensions,i=r.materials[e];let o;const c={},a=i.extensions||{},u=[];if(a[w.KHR_MATERIALS_UNLIT]){const d=s[w.KHR_MATERIALS_UNLIT];o=d.getMaterialType(),u.push(d.extendParams(c,i,t))}else{const d=i.pbrMetallicRoughness||{};if(c.color=new Z(1,1,1),c.opacity=1,Array.isArray(d.baseColorFactor)){const f=d.baseColorFactor;c.color.setRGB(f[0],f[1],f[2],V),c.opacity=f[3]}d.baseColorTexture!==void 0&&u.push(t.assignTexture(c,"map",d.baseColorTexture,oe)),c.metalness=d.metallicFactor!==void 0?d.metallicFactor:1,c.roughness=d.roughnessFactor!==void 0?d.roughnessFactor:1,d.metallicRoughnessTexture!==void 0&&(u.push(t.assignTexture(c,"metalnessMap",d.metallicRoughnessTexture)),u.push(t.assignTexture(c,"roughnessMap",d.metallicRoughnessTexture))),o=this._invokeOne(function(f){return f.getMaterialType&&f.getMaterialType(e)}),u.push(Promise.all(this._invokeAll(function(f){return f.extendMaterialParams&&f.extendMaterialParams(e,c)})))}i.doubleSided===!0&&(c.side=Wt);const l=i.alphaMode||ve.OPAQUE;if(l===ve.BLEND?(c.transparent=!0,c.depthWrite=!1):(c.transparent=!1,l===ve.MASK&&(c.alphaTest=i.alphaCutoff!==void 0?i.alphaCutoff:.5)),i.normalTexture!==void 0&&o!==Y&&(u.push(t.assignTexture(c,"normalMap",i.normalTexture)),c.normalScale=new we(1,1),i.normalTexture.scale!==void 0)){const d=i.normalTexture.scale;c.normalScale.set(d,d)}if(i.occlusionTexture!==void 0&&o!==Y&&(u.push(t.assignTexture(c,"aoMap",i.occlusionTexture)),i.occlusionTexture.strength!==void 0&&(c.aoMapIntensity=i.occlusionTexture.strength)),i.emissiveFactor!==void 0&&o!==Y){const d=i.emissiveFactor;c.emissive=new Z().setRGB(d[0],d[1],d[2],V)}return i.emissiveTexture!==void 0&&o!==Y&&u.push(t.assignTexture(c,"emissiveMap",i.emissiveTexture,oe)),Promise.all(u).then(function(){const d=new o(c);return i.name&&(d.name=i.name),j(d,i),t.associations.set(d,{materials:e}),i.extensions&&z(s,d,i),d})}createUniqueName(e){const t=Yt.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,r=this.extensions,s=this.primitiveCache;function i(c){return r[w.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(c,t).then(function(a){return tt(a,c,t)})}const o=[];for(let c=0,a=e.length;c<a;c++){const u=e[c],l=Vs(u),d=s[l];if(d)o.push(d.promise);else{let f;u.extensions&&u.extensions[w.KHR_DRACO_MESH_COMPRESSION]?f=i(u):f=tt(new zt,u,t),s[l]={primitive:u,promise:f},o.push(f)}}return Promise.all(o)}loadMesh(e){const t=this,r=this.json,s=this.extensions,i=r.meshes[e],o=i.primitives,c=[];for(let a=0,u=o.length;a<u;a++){const l=o[a].material===void 0?js(this.cache):this.getDependency("material",o[a].material);c.push(l)}return c.push(t.loadGeometries(o)),Promise.all(c).then(function(a){const u=a.slice(0,a.length-1),l=a[a.length-1],d=[];for(let h=0,p=l.length;h<p;h++){const m=l[h],g=o[h];let T;const A=u[h];if(g.mode===k.TRIANGLES||g.mode===k.TRIANGLE_STRIP||g.mode===k.TRIANGLE_FAN||g.mode===void 0)T=i.isSkinnedMesh===!0?new Qt(m,A):new Ee(m,A),T.isSkinnedMesh===!0&&T.normalizeSkinWeights(),g.mode===k.TRIANGLE_STRIP?T.geometry=$e(T.geometry,ut):g.mode===k.TRIANGLE_FAN&&(T.geometry=$e(T.geometry,Ce));else if(g.mode===k.LINES)T=new $t(m,A);else if(g.mode===k.LINE_STRIP)T=new Zt(m,A);else if(g.mode===k.LINE_LOOP)T=new Jt(m,A);else if(g.mode===k.POINTS)T=new es(m,A);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+g.mode);Object.keys(T.geometry.morphAttributes).length>0&&Ks(T,i),T.name=t.createUniqueName(i.name||"mesh_"+e),j(T,i),g.extensions&&z(s,T,g),t.assignFinalMaterial(T),d.push(T)}for(let h=0,p=d.length;h<p;h++)t.associations.set(d[h],{meshes:e,primitives:h});if(d.length===1)return i.extensions&&z(s,d[0],i),d[0];const f=new Ie;i.extensions&&z(s,f,i),t.associations.set(f,{meshes:e});for(let h=0,p=d.length;h<p;h++)f.add(d[h]);return f})}loadCamera(e){let t;const r=this.json.cameras[e],s=r[r.type];if(!s){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return r.type==="perspective"?t=new gt(ts.radToDeg(s.yfov),s.aspectRatio||1,s.znear||1,s.zfar||2e6):r.type==="orthographic"&&(t=new ss(-s.xmag,s.xmag,s.ymag,-s.ymag,s.znear,s.zfar)),r.name&&(t.name=this.createUniqueName(r.name)),j(t,r),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],r=[];for(let s=0,i=t.joints.length;s<i;s++)r.push(this._loadNodeShallow(t.joints[s]));return t.inverseBindMatrices!==void 0?r.push(this.getDependency("accessor",t.inverseBindMatrices)):r.push(null),Promise.all(r).then(function(s){const i=s.pop(),o=s,c=[],a=[];for(let u=0,l=o.length;u<l;u++){const d=o[u];if(d){c.push(d);const f=new Te;i!==null&&f.fromArray(i.array,u*16),a.push(f)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[u])}return new ns(c,a)})}loadAnimation(e){const t=this.json,r=this,s=t.animations[e],i=s.name?s.name:"animation_"+e,o=[],c=[],a=[],u=[],l=[];for(let d=0,f=s.channels.length;d<f;d++){const h=s.channels[d],p=s.samplers[h.sampler],m=h.target,g=m.node,T=s.parameters!==void 0?s.parameters[p.input]:p.input,A=s.parameters!==void 0?s.parameters[p.output]:p.output;m.node!==void 0&&(o.push(this.getDependency("node",g)),c.push(this.getDependency("accessor",T)),a.push(this.getDependency("accessor",A)),u.push(p),l.push(m))}return Promise.all([Promise.all(o),Promise.all(c),Promise.all(a),Promise.all(u),Promise.all(l)]).then(function(d){const f=d[0],h=d[1],p=d[2],m=d[3],g=d[4],T=[];for(let A=0,E=f.length;A<E;A++){const x=f[A],_=h[A],D=p[A],M=m[A],se=g[A];if(x===void 0)continue;x.updateMatrix&&x.updateMatrix();const q=r._createAnimationTracks(x,_,D,M,se);if(q)for(let be=0;be<q.length;be++)T.push(q[be])}return new rs(i,void 0,T)})}createNodeMesh(e){const t=this.json,r=this,s=t.nodes[e];return s.mesh===void 0?null:r.getDependency("mesh",s.mesh).then(function(i){const o=r._getNodeRef(r.meshCache,s.mesh,i);return s.weights!==void 0&&o.traverse(function(c){if(c.isMesh)for(let a=0,u=s.weights.length;a<u;a++)c.morphTargetInfluences[a]=s.weights[a]}),o})}loadNode(e){const t=this.json,r=this,s=t.nodes[e],i=r._loadNodeShallow(e),o=[],c=s.children||[];for(let u=0,l=c.length;u<l;u++)o.push(r.getDependency("node",c[u]));const a=s.skin===void 0?Promise.resolve(null):r.getDependency("skin",s.skin);return Promise.all([i,Promise.all(o),a]).then(function(u){const l=u[0],d=u[1],f=u[2];f!==null&&l.traverse(function(h){h.isSkinnedMesh&&h.bind(f,Xs)});for(let h=0,p=d.length;h<p;h++)l.add(d[h]);return l})}_loadNodeShallow(e){const t=this.json,r=this.extensions,s=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const i=t.nodes[e],o=i.name?s.createUniqueName(i.name):"",c=[],a=s._invokeOne(function(u){return u.createNodeMesh&&u.createNodeMesh(e)});return a&&c.push(a),i.camera!==void 0&&c.push(s.getDependency("camera",i.camera).then(function(u){return s._getNodeRef(s.cameraCache,i.camera,u)})),s._invokeAll(function(u){return u.createNodeAttachment&&u.createNodeAttachment(e)}).forEach(function(u){c.push(u)}),this.nodeCache[e]=Promise.all(c).then(function(u){let l;if(i.isBone===!0?l=new is:u.length>1?l=new Ie:u.length===1?l=u[0]:l=new ae,l!==u[0])for(let d=0,f=u.length;d<f;d++)l.add(u[d]);if(i.name&&(l.userData.name=i.name,l.name=o),j(l,i),i.extensions&&z(r,l,i),i.matrix!==void 0){const d=new Te;d.fromArray(i.matrix),l.applyMatrix4(d)}else i.translation!==void 0&&l.position.fromArray(i.translation),i.rotation!==void 0&&l.quaternion.fromArray(i.rotation),i.scale!==void 0&&l.scale.fromArray(i.scale);return s.associations.has(l)||s.associations.set(l,{}),s.associations.get(l).nodes=e,l}),this.nodeCache[e]}loadScene(e){const t=this.extensions,r=this.json.scenes[e],s=this,i=new Ie;r.name&&(i.name=s.createUniqueName(r.name)),j(i,r),r.extensions&&z(t,i,r);const o=r.nodes||[],c=[];for(let a=0,u=o.length;a<u;a++)c.push(s.getDependency("node",o[a]));return Promise.all(c).then(function(a){for(let l=0,d=a.length;l<d;l++)i.add(a[l]);const u=l=>{const d=new Map;for(const[f,h]of s.associations)(f instanceof Me||f instanceof Xe)&&d.set(f,h);return l.traverse(f=>{const h=s.associations.get(f);h!=null&&d.set(f,h)}),d};return s.associations=u(i),i})}_createAnimationTracks(e,t,r,s,i){const o=[],c=e.name?e.name:e.uuid,a=[];X[i.path]===X.weights?e.traverse(function(f){f.morphTargetInfluences&&a.push(f.name?f.name:f.uuid)}):a.push(c);let u;switch(X[i.path]){case X.weights:u=Ye;break;case X.rotation:u=ze;break;case X.position:case X.scale:u=We;break;default:switch(r.itemSize){case 1:u=Ye;break;case 2:case 3:default:u=We;break}break}const l=s.interpolation!==void 0?Gs[s.interpolation]:Tt,d=this._getArrayFromAccessor(r);for(let f=0,h=a.length;f<h;f++){const p=new u(a[f]+"."+X[i.path],t.array,d,l);s.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(p),o.push(p)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const r=Fe(t.constructor),s=new Float32Array(t.length);for(let i=0,o=t.length;i<o;i++)s[i]=t[i]*r;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(r){const s=this instanceof ze?Bs:yt;return new s(this.times,this.values,this.getValueSize()/3,r)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Ys(n,e,t){const r=e.attributes,s=new Ge;if(r.POSITION!==void 0){const c=t.json.accessors[r.POSITION],a=c.min,u=c.max;if(a!==void 0&&u!==void 0){if(s.set(new W(a[0],a[1],a[2]),new W(u[0],u[1],u[2])),c.normalized){const l=Fe(ee[c.componentType]);s.min.multiplyScalar(l),s.max.multiplyScalar(l)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const i=e.targets;if(i!==void 0){const c=new W,a=new W;for(let u=0,l=i.length;u<l;u++){const d=i[u];if(d.POSITION!==void 0){const f=t.json.accessors[d.POSITION],h=f.min,p=f.max;if(h!==void 0&&p!==void 0){if(a.setX(Math.max(Math.abs(h[0]),Math.abs(p[0]))),a.setY(Math.max(Math.abs(h[1]),Math.abs(p[1]))),a.setZ(Math.max(Math.abs(h[2]),Math.abs(p[2]))),f.normalized){const m=Fe(ee[f.componentType]);a.multiplyScalar(m)}c.max(a)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}s.expandByVector(c)}n.boundingBox=s;const o=new ls;s.getCenter(o.center),o.radius=s.min.distanceTo(s.max)/2,n.boundingSphere=o}function tt(n,e,t){const r=e.attributes,s=[];function i(o,c){return t.getDependency("accessor",o).then(function(a){n.setAttribute(c,a)})}for(const o in r){const c=Pe[o]||o.toLowerCase();c in n.attributes||s.push(i(r[o],c))}if(e.indices!==void 0&&!n.index){const o=t.getDependency("accessor",e.indices).then(function(c){n.setIndex(c)});s.push(o)}return Qe.workingColorSpace!==V&&"COLOR_0"in r&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${Qe.workingColorSpace}" not supported.`),j(n,e),Ys(n,e,t),Promise.all(s).then(function(){return e.targets!==void 0?Us(n,e.targets,t):n})}var zs=Object.defineProperty,xt=n=>{throw TypeError(n)},Qs=(n,e,t)=>e in n?zs(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,R=(n,e,t)=>Qs(n,typeof e!="symbol"?e+"":e,t),wt=(n,e,t)=>e.has(n)||xt("Cannot "+t),S=(n,e,t)=>(wt(n,e,"read from private field"),t?t.call(n):e.get(n)),ie=(n,e,t)=>e.has(n)?xt("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(n):e.set(n,t),Ae=(n,e,t,r)=>(wt(n,e,"write to private field"),e.set(n,t),t),st=(n,e,t,r)=>({set _(s){Ae(n,e,s)},get _(){return S(n,e,r)}}),y=Symbol("internal"),Ue=4,Et=8,St=20,$s=(1<<Ue)-1,ye=(1<<Et)-1,de=(1<<St)-1,ce=St,F=ce+Et;function Zs(n,e,t){return(n&$s)<<F|(e&ye)<<ce|t&de}var L=n=>n&de,Js=n=>n>>>F,nt=n=>n>>>ce&ye,en=n=>n&-267386881|((n>>>ce&ye)+1&ye)<<ce,tn=n=>{const e=n[y];e.bitflag*=2,e.bitflag>=2**31&&(e.bitflag=1,e.entityMasks.push(new Array))},sn=class{constructor(n,e){R(this,"generationId"),R(this,"bitflag"),R(this,"trait"),R(this,"store"),R(this,"queries"),R(this,"notQueries"),R(this,"schema"),R(this,"changedSubscriptions");const t=n[y],r=e[y];this.generationId=t.entityMasks.length-1,this.bitflag=t.bitflag,this.trait=e,this.store=r.createStore(),this.queries=new Set,this.notQueries=new Set,this.schema=e.schema,this.changedSubscriptions=new Set,r.stores[n.id]=this.store}};function nn(n){const t=Object.keys(n).map(s=>`if ('${s}' in value) store.${s}[index] = value.${s};`).join(`
    `);return new Function("index","store","value",`
		${t}
	  `)}function rn(n){const t=Object.keys(n).map(s=>`store.${s}[index] = value.${s};`).join(`
    `);return new Function("index","store","value",`
		${t}
	  `)}function on(n){const t=Object.keys(n).map(s=>`if (store.${s}[index] !== value.${s}) {
            store.${s}[index] = value.${s};
            changed = true;
        }`).join(`
    `);return new Function("index","store","value",`
        let changed = false;
        ${t}
        return changed;
        `)}function an(n){const t=`{ ${Object.keys(n).map(s=>`${s}: store.${s}[index]`).join(", ")} }`;return new Function("index","store",`
        return ${t};
        `)}function Rt(n){return(e,t,r)=>{t[e]=r}}function cn(n){return(e,t,r)=>{let s=!1;return r!==t[e]&&(t[e]=r,s=!0),s}}function un(n){return(e,t)=>t[e]}var ln={soa:nn,aos:Rt},dn={soa:rn,aos:Rt},hn={soa:on,aos:cn},fn={soa:an,aos:un};function pn(n){if(typeof n=="function")return[];{const e={};for(const t in n)e[t]=[];return e}}var mn=0;function gn(n={}){const e=typeof n=="function",t=e?"aos":"soa",r=Object.assign(function(s){return[r,s]},{schema:n,[y]:{set:ln[t](n),fastSet:dn[t](n),fastSetWithChangeDetection:hn[t](n),get:fn[t](n),stores:[],id:mn++,createStore:()=>pn(n),isPairTrait:!1,relation:null,pairTarget:null,isTag:!e&&Object.keys(n).length===0,type:t}});return r}var v=gn;function ue(n,e){const t=n[y],r=new sn(n,e);t.traitData.set(e,r),n.traits.add(e),tn(n)}function Tn(n,e,...t){const r=n[y];for(let s=0;s<t.length;s++){let i,o;if(Array.isArray(t[s])?[i,o]=t[s]:i=t[s],e.has(i))return;const c=i[y];r.traitData.has(i)||ue(n,i);const a=r.traitData.get(i),{generationId:u,bitflag:l,queries:d}=a,f=L(e);r.entityMasks[u][f]|=l;for(const m of r.dirtyMasks.values())m[u]||(m[u]=[]),m[u][f]|=l;for(const m of d)m.toRemove.remove(e),m.check(n,e,{type:"add",traitData:a})?m.add(e):m.remove(n,e);r.entityTraits.get(e).add(i);const h=c.relation,p=c.pairTarget;if(c.isPairTrait&&h!==null&&p!==null&&(r.relationTargetEntities.add(p),e.add(le(O,p)),e.add(le(h,O)),h[y].exclusive===!0&&p!==O)){const m=Se(n,h,e)[0];m!=null&&m!==p&&$(n,e,h(m))}if(c.type==="soa"){const m={};for(const g in a.schema)typeof a.schema[g]=="function"?m[g]=a.schema[g]():m[g]=a.schema[g];e.set(i,{...m,...o},!1)}else{const m=o??a.schema();e.set(i,m,!1)}}}function $(n,e,...t){const r=n[y];for(let s=0;s<t.length;s++){const i=t[s],o=i[y];if(!e.has(i))return;const c=r.traitData.get(i),{generationId:a,bitflag:u,queries:l}=c,d=L(e);r.entityMasks[a][d]&=~u;for(const f of r.dirtyMasks.values())f[a][d]|=u;for(const f of l)f.check(n,e,{type:"remove",traitData:c})?f.add(e):f.remove(n,e);if(r.entityTraits.get(e).delete(i),o.isPairTrait){n.query(O(e)).length===0&&r.relationTargetEntities.delete(e);const f=o.pairTarget;$(n,e,le(O,f));const h=o.relation;Se(n,h,e).length===0&&$(n,e,le(h,O))}}}function An(n,e,t){const r=n[y],s=r.traitData.get(t);if(!s)return!1;const{generationId:i,bitflag:o}=s,c=L(e);return(r.entityMasks[i][c]&o)===o}function rt(n,e){return n[y].traitData.get(e).store}function bt(n){const e=new Map,t=()=>v((n==null?void 0:n.store)??{});function r(s){if(s===void 0)throw Error("Relation target is undefined");return s==="*"&&(s=O),_t(r,t,e,s)}return Object.assign(r,{[y]:{pairsMap:e,createTrait:t,exclusive:(n==null?void 0:n.exclusive)??!1,autoRemoveTarget:(n==null?void 0:n.autoRemoveTarget)??!1}})}var yn=bt;function _t(n,e,t,r){if(!t.has(r)){const s=e(),i=s[y];i.isPairTrait=!0,i.relation=n,i.pairTarget=r,t.set(r,s)}return t.get(r)}var Se=(n,e,t)=>{const s=n[y].entityTraits.get(t)||[],i=[];for(const o of s){const c=o[y];c.relation===e&&c.pairTarget!==O&&i.push(c.pairTarget)}return i},le=(n,e)=>{if(n===void 0)throw Error("Relation is undefined");if(e===void 0)throw Error("Relation target is undefined");e==="*"&&(e=O);const t=n[y],r=t.pairsMap,s=t.createTrait;return _t(n,s,r,e)},O=bt();function xn(){return{worldCursor:0,releasedWorldIds:[],maxWorlds:2**Ue}}function wn(n){if(n.releasedWorldIds.length>0)return n.releasedWorldIds.pop();if(n.worldCursor>=n.maxWorlds)throw new Error(`Koota: Too many worlds created. The maximum is ${n.maxWorlds}.`);return n.worldCursor++}function En(n,e){if(e<0||e>=n.maxWorlds)throw new Error(`Invalid world ID: ${e}`);e===n.worldCursor-1?n.worldCursor--:e<n.worldCursor&&!n.releasedWorldIds.includes(e)&&n.releasedWorldIds.push(e)}var I={worlds:new Array(Ue**2),cachedQueries:new Map,worldIndex:xn()},Ke=class{constructor(n,e,t){this.type=n,this.id=e,this.traits=t,R(this,"traitIds"),this.traitIds=t.map(r=>r[y].id)}},Sn=3;function Rn(){return Sn}function bn(n,e){const t=n[y],r=structuredClone(t.entityMasks);t.trackingSnapshots.set(e,r),t.dirtyMasks.set(e,r.map(s=>s.map(()=>0))),t.changedMasks.set(e,r.map(s=>s.map(()=>0)))}function Mt(n,e,t){const r=n[y];if(!e.has(t))return;r.traitData.has(t)||ue(n,t);const s=r.traitData.get(t);for(const i of r.changedMasks.values()){const o=L(e);i[o]||(i[o]=new Array);const c=t[y].id;i[o][c]=1}for(const i of s.queries){if(!i.hasChangedModifiers)continue;i.check(n,e,{type:"change",traitData:s})?i.add(e):i.remove(n,e)}for(const i of s.changedSubscriptions)i(e)}var it=n=>({aliveCount:0,dense:[],sparse:[],maxId:0,worldId:n}),_n=n=>{if(n.aliveCount<n.dense.length){const r=en(n.dense[n.aliveCount]);return n.dense[n.aliveCount]=r,n.sparse[L(r)]=n.aliveCount,n.aliveCount++,r}const e=n.maxId++,t=Zs(n.worldId,0,e);return n.dense.push(t),n.sparse[e]=n.aliveCount,n.aliveCount++,t},Mn=(n,e)=>{const t=L(e),r=n.sparse[t];if(r===void 0||r>=n.aliveCount)return;const s=n.aliveCount-1,i=n.dense[s],o=L(i);n.sparse[o]=r,n.dense[r]=i,n.sparse[t]=s,n.dense[s]=e,n.aliveCount--},In=(n,e)=>{const t=n.sparse[L(e)];if(t===void 0||t>=n.aliveCount)return!1;const r=n.dense[t];return nt(e)===nt(r)&&Js(e)===n.worldId},Ln=n=>n.dense.slice(0,n.aliveCount);Number.prototype.add=function(...n){const e=this>>>F,t=I.worlds[e];return Tn(t,this,...n)};Number.prototype.remove=function(...n){const e=this>>>F,t=I.worlds[e];return $(t,this,...n)};Number.prototype.has=function(n){const e=this>>>F,t=I.worlds[e];return An(t,this,n)};Number.prototype.destroy=function(){const n=this>>>F,e=I.worlds[n];return He(e,this)};Number.prototype.changed=function(n){const e=this>>>F,t=I.worlds[e];return Mt(t,this,n)};Number.prototype.get=function(n){const e=this>>>F,r=I.worlds[e][y],s=r.traitData.get(n);if(!s)return;const i=this&de;if((r.entityMasks[s.generationId][i]&s.bitflag)!==s.bitflag)return;const c=n[y],a=c.stores[e];return c.get(i,a)};Number.prototype.set=function(n,e,t=!0){const r=n[y],s=this&de,i=this>>>F,o=r.stores[i];e instanceof Function&&(e=e(r.get(s,o))),r.set(s,o,e),t&&Mt(I.worlds[i],this,n)};Number.prototype.targetsFor=function(n){const e=this>>>F,t=I.worlds[e];return Se(t,n,this)};Number.prototype.targetFor=function(n){const e=this>>>F,t=I.worlds[e];return Se(t,n,this)[0]};Number.prototype.id=function(){return this&de};function De(n,...e){const t=n[y],r=_n(t.entityIndex);for(const s of t.notQueries)s.check(n,r)&&s.add(r),s.resetTrackingBitmasks(r.id());return t.entityTraits.set(r,new Set),r.add(...e),r}var vn=new Set,kn=[];function He(n,e){const t=n[y];if(!n.has(e))throw new Error("Koota: The entity being destroyed does not exist.");const r=kn,s=vn;for(r.length=0,r.push(e),s.clear();r.length>0;){const i=r.pop();if(s.has(i))continue;if(s.add(i),t.relationTargetEntities.has(i)){for(const a of n.query(O(i)))if(n.has(a))for(const u of t.entityTraits.get(a)){const l=u[y];if(!l.isPairTrait)continue;const d=l.relation[y];$(n,a,le(O,i)),l.pairTarget===i&&($(n,a,u),d.autoRemoveTarget&&r.push(a))}}const o=t.entityTraits.get(i);if(o)for(const a of o)$(n,i,a);Mn(t.entityIndex,i),t.entityTraits.delete(e);const c=L(i);for(let a=0;a<t.entityMasks.length;a++)t.entityMasks[a][c]=0}}var C,H,B,ot=class{constructor(){ie(this,C,[]),ie(this,H,[]),ie(this,B,0)}has(n){const e=S(this,H)[n];return e<S(this,B)&&S(this,C)[e]===n}add(n){this.has(n)||(S(this,H)[n]=S(this,B),S(this,C)[st(this,B)._++]=n)}remove(n){if(!this.has(n))return;const e=S(this,H)[n];st(this,B)._--;const t=S(this,C)[S(this,B)];t!==n&&(S(this,C)[e]=t,S(this,H)[t]=e)}clear(){for(let n=0;n<S(this,B);n++)S(this,H)[S(this,C)[n]]=0;Ae(this,B,0)}sort(){S(this,C).sort((n,e)=>n-e);for(let n=0;n<S(this,C).length;n++)S(this,H)[S(this,C)[n]]=n}getIndex(n){return S(this,H)[n]}get dense(){return S(this,C).slice(0,S(this,B))}get sparse(){return S(this,H)}};C=new WeakMap;H=new WeakMap;B=new WeakMap;var he=new Float32Array(1024),pe=n=>{he.fill(0);let e=0;for(let s=0;s<n.length;s++){const i=n[s];if(i instanceof Ke){const o=i.id,c=i.traitIds;for(let a=0;a<c.length;a++){const u=c[a];he[e++]=o*1e5+u}}else{const o=i[y].id;he[e++]=o}}const t=he.subarray(0,e);return t.sort(),t.join(",")},Be=v(),fe=class{constructor(n,e=[]){var s,i;R(this,"version",0),R(this,"world"),R(this,"parameters"),R(this,"hash"),R(this,"traits",[]),R(this,"traitData",{required:[],forbidden:[],or:[],added:[],removed:[],changed:[],all:[]}),R(this,"bitmasks",[]),R(this,"generations"),R(this,"entities",new ot),R(this,"isTracking",!1),R(this,"hasChangedModifiers",!1),R(this,"changedTraits",new Set),R(this,"toRemove",new ot),R(this,"addSubscriptions",new Set),R(this,"removeSubscriptions",new Set),this.world=n,this.parameters=e;const t=n[y],r=[];for(let o=0;o<e.length;o++){const c=e[o];if(c instanceof Ke){const a=c.traits;for(let u=0;u<a.length;u++){const l=a[u];t.traitData.has(l)||ue(n,l)}if(c.type==="not"&&this.traitData.forbidden.push(...a.map(u=>t.traitData.get(u))),c.type==="or"&&this.traitData.or.push(...a.map(u=>t.traitData.get(u))),c.type.includes("added")){for(const l of a){const d=t.traitData.get(l);this.traitData.added.push(d),this.traits.push(l)}this.isTracking=!0;const u=c.type.split("-")[1];r.push({type:"add",id:parseInt(u),traits:this.traitData.added})}if(c.type.includes("removed")){for(const l of a){const d=t.traitData.get(l);this.traitData.removed.push(d),this.traits.push(l)}this.isTracking=!0;const u=c.type.split("-")[1];r.push({type:"remove",id:parseInt(u),traits:this.traitData.removed})}if(c.type.includes("changed")){for(const l of a){this.changedTraits.add(l);const d=t.traitData.get(l);this.traitData.changed.push(d),this.traits.push(l),this.hasChangedModifiers=!0}this.isTracking=!0;const u=c.type.split("-")[1];r.push({type:"change",id:parseInt(u),traits:this.traitData.changed})}}else{const a=c;t.traitData.has(a)||ue(n,a),this.traitData.required.push(t.traitData.get(a)),this.traits.push(a)}}if(this.traitData.forbidden.push(t.traitData.get(Be)),this.traitData.all=[...this.traitData.required,...this.traitData.forbidden,...this.traitData.or,...this.traitData.added,...this.traitData.removed,...this.traitData.changed],this.generations=this.traitData.all.map(o=>o.generationId).reduce((o,c)=>(o.includes(c)||o.push(c),o),[]),this.bitmasks=this.generations.map(o=>{const c=this.traitData.required.filter(h=>h.generationId===o).reduce((h,p)=>h|p.bitflag,0),a=this.traitData.forbidden.filter(h=>h.generationId===o).reduce((h,p)=>h|p.bitflag,0),u=this.traitData.or.filter(h=>h.generationId===o).reduce((h,p)=>h|p.bitflag,0),l=this.traitData.added.filter(h=>h.generationId===o).reduce((h,p)=>h|p.bitflag,0),d=this.traitData.removed.filter(h=>h.generationId===o).reduce((h,p)=>h|p.bitflag,0),f=this.traitData.changed.filter(h=>h.generationId===o).reduce((h,p)=>h|p.bitflag,0);return{required:c|l,forbidden:a,or:u,added:l,removed:d,changed:f,addedTracker:[],removedTracker:[],changedTracker:[]}}),this.hash=pe(e),t.queries.add(this),t.queriesHashMap.set(this.hash,this),this.traitData.all.forEach(o=>{o.queries.add(this)}),this.traitData.forbidden.length>0&&t.notQueries.add(this),r.length>0)for(let o=0;o<r.length;o++){const c=r[o].type,a=r[o].id,u=r[o].traits,l=t.trackingSnapshots.get(a),d=t.dirtyMasks.get(a),f=t.changedMasks.get(a);for(const h of t.entityIndex.dense){let p=!0;const m=L(h);for(const g of u){const{generationId:T,bitflag:A}=g,E=((s=l[T])==null?void 0:s[m])||0,x=((i=t.entityMasks[T])==null?void 0:i[m])||0;let _=!1;switch(c){case"add":_=(E&A)===0&&(x&A)===A;break;case"remove":_=(E&A)===A&&(x&A)===0||(E&A)===0&&(x&A)===0&&(d[T][m]&A)===A;break;case"change":_=(f[T][m]&A)===A;break}if(!_){p=!1;break}}p&&this.add(h)}}else if(this.traitData.required.length>0||this.traitData.forbidden.length>0||this.traitData.or.length>0){const o=t.entityIndex.dense;for(let c=0;c<o.length;c++){const a=o[c];this.check(n,a)&&this.add(a)}}}run(n){this.commitRemovals(n);const e=this.entities.dense.slice();return this.isTracking&&this.entities.clear(),e}add(n){this.toRemove.remove(n),this.entities.add(n);for(const e of this.addSubscriptions)e(n);this.version++}remove(n,e){if(!this.entities.has(e)||this.toRemove.has(e))return;const t=n[y];this.toRemove.add(e),t.dirtyQueries.add(this);for(const r of this.removeSubscriptions)r(e)}check(n,e,t){const{bitmasks:r,generations:s}=this,i=n[y],o=L(e);if(this.traitData.all.length===0)return!1;for(let c=0;c<s.length;c++){const a=s[c],u=r[c],{required:l,forbidden:d,or:f,added:h,removed:p,changed:m}=u,g=i.entityMasks[a][o];if(!d&&!l&&!f&&!p&&!h&&!m)return!1;const T=t&&t.traitData.generationId===a;if(this.isTracking&&T){const A=t.traitData.bitflag;if(t.type==="add"){if(p&A)return!1;h&A&&(u.addedTracker[o]|=A)}else if(t.type==="remove"){if(h&A||(p&A&&(u.removedTracker[o]|=A),m&A))return!1}else if(t.type==="change"){if(!(g&A))return!1;m&A&&(u.changedTracker[o]|=A)}}if(g&d||(g&l)!==l||f!==0&&!(g&f)||h&&T&&((u.addedTracker[o]||0)&h)!==h||p&&T&&((u.removedTracker[o]||0)&p)!==p||m&&T&&((u.changedTracker[o]||0)&m)!==m)return!1}return!0}commitRemovals(n){const e=n[y];if(e.dirtyQueries.size){for(const t of e.dirtyQueries)for(let r=t.toRemove.dense.length-1;r>=0;r--){const s=t.toRemove.dense[r];t.toRemove.remove(s),t.entities.remove(s)}e.dirtyQueries.clear()}}resetTrackingBitmasks(n){for(const e of this.bitmasks)e.addedTracker[n]=0,e.removedTracker[n]=0,e.changedTracker[n]=0}};function at(n,e){if(n===e)return!0;if(typeof n!="object"||n===null||typeof e!="object"||e===null)return!1;const t=Object.keys(n),r=Object.keys(e);if(t.length!==r.length)return!1;for(const s of t)if(!e.hasOwnProperty(s)||n[s]!==e[s])return!1;return!0}function Dn(n,e,t){n.commitRemovals(e);const r=n.entities.dense.slice();n.isTracking&&n.entities.clear();const s=[],i=[];ct(t,i,s,e);const o=Object.assign(r,{updateEach(c,a={changeDetection:"auto"}){const u=new Array(i.length);if(a.changeDetection==="auto"){const l=[],d=[],f=[],h=[];for(let p=0;p<i.length;p++){const m=i[p],g=e[y].trackedTraits.has(m),T=n.hasChangedModifiers&&n.changedTraits.has(m);g||T?f.push(p):h.push(p)}for(let p=0;p<r.length;p++){const m=r[p],g=L(m);for(let T=0;T<i.length;T++){const E=i[T][y],x=E.get(g,s[T]);u[T]=x,d[T]=E.type==="aos"?{...x}:null}if(c(u,m,p),!!e.has(m)){for(let T=0;T<f.length;T++){const A=f[T],E=i[A],x=E[y],_=u[A],D=s[A];let M=!1;x.type==="aos"?(M=x.fastSetWithChangeDetection(g,D,_),M||(M=!at(_,d[A]))):M=x.fastSetWithChangeDetection(g,D,_),M&&l.push([m,E])}for(let T=0;T<h.length;T++){const A=h[T],x=i[A][y],_=s[A];x.fastSet(g,_,u[A])}}}for(let p=0;p<l.length;p++){const[m,g]=l[p];m.changed(g)}}else if(a.changeDetection==="always"){const l=[],d=[];for(let f=0;f<r.length;f++){const h=r[f],p=L(h);for(let m=0;m<i.length;m++){const T=i[m][y],A=T.get(p,s[m]);u[m]=A,d[m]=T.type==="aos"?{...A}:null}if(c(u,h,f),!!e.has(h))for(let m=0;m<i.length;m++){const g=i[m],T=g[y],A=u[m];let E=!1;T.type==="aos"?(E=T.fastSetWithChangeDetection(p,s[m],A),E||(E=!at(A,d[m]))):E=T.fastSetWithChangeDetection(p,s[m],A),E&&l.push([h,g])}}for(let f=0;f<l.length;f++){const[h,p]=l[f];h.changed(p)}}else if(a.changeDetection==="never")for(let l=0;l<r.length;l++){const d=r[l],f=L(d);for(let h=0;h<i.length;h++){const m=i[h][y];u[h]=m.get(f,s[h])}if(c(u,d,l),!!e.has(d))for(let h=0;h<i.length;h++)i[h][y].fastSet(f,s[h],u[h])}return o},useStores(c){return c(s,r),o},select(...c){return i.length=0,s.length=0,ct(c,i,s,e),o}});return o}function ct(n,e,t,r){for(let s=0;s<n.length;s++){const i=n[s];if(i instanceof Ke){if(i.type==="not")continue;const o=i.traits;for(const c of o)c[y].isTag||(e.push(c),t.push(rt(r,c)))}else{if(i[y].isTag)continue;e.push(i),t.push(rt(r,i))}}}var It,Q,J;It=y;var Cn=class{constructor(...n){ie(this,Q,wn(I.worldIndex)),R(this,It,{entityIndex:it(S(this,Q)),entityMasks:[[]],entityTraits:new Map,bitflag:1,traitData:new Map,queries:new Set,queriesHashMap:new Map,notQueries:new Set,dirtyQueries:new Set,relationTargetEntities:new Set,dirtyMasks:new Map,trackingSnapshots:new Map,changedMasks:new Map,worldEntity:null,trackedTraits:new Set}),ie(this,J,!1),R(this,"traits",new Set),this.init(...n)}get id(){return S(this,Q)}get isInitialized(){return S(this,J)}get entities(){return Ln(this[y].entityIndex)}init(...n){const e=this[y];if(S(this,J))return;Ae(this,J,!0),I.worlds[S(this,Q)]=this;const t=Rn();for(let r=0;r<t;r++)bn(this,r);for(const[r,s]of I.cachedQueries){const i=new fe(this,s);e.queriesHashMap.set(r,i)}e.worldEntity=De(this,Be,...n)}spawn(...n){return De(this,...n)}has(n){return typeof n=="number"?In(this[y].entityIndex,n):this[y].worldEntity.has(n)}add(...n){this[y].worldEntity.add(...n)}remove(...n){this[y].worldEntity.remove(...n)}get(n){return this[y].worldEntity.get(n)}set(n,e){this[y].worldEntity.set(n,e)}destroy(){He(this,this[y].worldEntity),this[y].worldEntity=null,this.entities.forEach(n=>He(this,n)),this.reset(),Ae(this,J,!1),En(I.worldIndex,S(this,Q)),I.worlds.splice(I.worlds.indexOf(this),1)}reset(){const n=this[y];n.entityIndex=it(S(this,Q)),n.entityTraits.clear(),n.notQueries.clear(),n.entityMasks=[[]],n.bitflag=1,n.traitData.clear(),this.traits.clear(),n.queries.clear(),n.queriesHashMap.clear(),n.dirtyQueries.clear(),n.relationTargetEntities.clear(),n.trackingSnapshots.clear(),n.dirtyMasks.clear(),n.changedMasks.clear(),n.trackedTraits.clear(),n.worldEntity=De(this,Be)}query(...n){const e=this[y];if(typeof n[0]=="string"){const t=e.queriesHashMap.get(n[0]);return t?t.run(this):[]}else{const t=n,r=pe(t);let s=e.queriesHashMap.get(r);return s||(s=new fe(this,t),e.queriesHashMap.set(r,s)),Dn(s,this,t)}}queryFirst(...n){return this.query(...n)[0]}onAdd(n,e){const t=this[y],r=pe(n);let s=t.queriesHashMap.get(r);return s||(s=new fe(this,n),t.queriesHashMap.set(r,s)),s.addSubscriptions.add(e),()=>s.addSubscriptions.delete(e)}onRemove(n,e){const t=this[y],r=pe(n);let s=t.queriesHashMap.get(r);return s||(s=new fe(this,n),t.queriesHashMap.set(r,s)),s.removeSubscriptions.add(e),()=>s.removeSubscriptions.delete(e)}onChange(n,e){const t=this[y];t.traitData.has(n)||ue(this,n);const r=t.traitData.get(n);return r.changedSubscriptions.add(e),t.trackedTraits.add(n),()=>{r.changedSubscriptions.delete(e),t.trackedTraits.delete(n)}}};Q=new WeakMap;J=new WeakMap;function Nn(...n){return new Cn(...n)}const me=yn({exclusive:!0,store:{posX:0,posY:0}}),b=v({posX:0,posY:0}),K=v({xVel:0,yVel:0}),Ve=v({fillColor:"#ffffff",squareSize:0}),P=v({mesh:new ae}),te=v({dir:"none"}),ge=v({thrustVec:0}),N=v({isDestroyed:!1}),U=v({x:0,y:0,width:0,height:0}),xe=v({object:new ae,box:new Ge,boxHelper:new ae}),Re=v(),qe=v(),Lt=v();function On(n,e){n.query(b,K).updateEach(([t,r])=>{t.posX+=r.xVel*e.deltaTime,t.posY+=r.yVel*e.deltaTime})}function Pn(n){n.query(b,me("*")).updateEach(([e,t],r)=>{const s=r.targetFor(me),i=s.get(b),o=r.get(me(s));e.posX=o.posX+i.posX,e.posY=o.posY+i.posY})}function Fn(n){const e=n.query(te,ge,K,qe);e.select(te,ge).updateEach(([r,s])=>{switch(r.dir){case"e":s.thrustVec=1;break;case"w":s.thrustVec=-1;break;case"none":s.thrustVec=0;break}});const t=1;e.select(ge,K).updateEach(([r,s])=>{s.xVel=r.thrustVec*t})}function Hn(n,e){const t=n.query(b,Re);for(const r of t){const s=r.get(b);let i=!1;for(const o of n.query(b,qe)){const c=o.get(b);if(s.posX>c.posX&&s.posY>c.posY){i=!0,e.callbackOnLoseCondition();break}}if(i)break}}function Bn(n,e){const r=n.query(b,P).flatMap(s=>{var a;if(!!((a=s.get(N))!=null&&a.isDestroyed))return[];const{mesh:o}=s.get(P),c=s.get(b);return o.position.x=c.posX*.01,o.position.y=c.posY*.01,[o]});r.length&&e.scene.add(...r)}function Gn(n,e){const t=n.query(xe).flatMap(r=>{var a;if(!!((a=r.get(N))!=null&&a.isDestroyed))return[];const{box:i,object:o,boxHelper:c}=r.get(xe);return i.setFromObject(o),[c]});t.length&&e.scene.add(...t)}function jn(n){const e=n.query(Re,b,U,N),t=n.query(Lt,b,U,N);e.forEach(r=>{const s=r.get(U);t.forEach(i=>{var u;if(!!((u=i.get(N))!=null&&u.isDestroyed))return;const c=i.get(U);c.x<s.x+s.width&&c.x+c.width>s.x&&c.y<s.y+s.height&&c.y+c.height>s.y&&(i.set(N,{isDestroyed:!0}),r.set(N,{isDestroyed:!0}))})})}function Un(n,e,t){n.query(b).forEach(r=>{const s=r.get(b);r.has(P)&&t.scene.remove(r.get(P).mesh),r.has(xe)&&t.scene.remove(r.get(xe).boxHelper),(s.posX<e.minX||s.posX>e.maxX||s.posY<e.minY||s.posY>e.maxY)&&r.destroy()})}function Kn(n,e){n.query(N).forEach(t=>{const{isDestroyed:r}=t.get(N);t.has(P)&&e.scene.remove(t.get(P).mesh),r&&t.destroy()})}function Vn(n){n.query(b,U).select(b,U).updateEach(([e,t])=>{t.x=e.posX-t.width/2,t.y=e.posY-t.width/2})}function qn(n,e){return n.spawn(b({posX:e.absolutePosition.x,posY:e.absolutePosition.y}),K({xVel:.01,yVel:0}))}function Xn(n,e,t){const r=[],s=[];if(t){r.push(P({mesh:t.model}));const i=new Ge().setFromObject(t.model),o=new W;i.getCenter(o);const c=new W;i.getSize(c),r.push(U({x:o.x-c.x/2*100,y:o.y+c.y/2*100,height:c.y*100,width:c.x*100}))}else s.push(U({x:e.absolutePosition.x,y:e.absolutePosition.y,height:25,width:25}));return n.spawn(b({posX:e.absolutePosition.x,posY:e.absolutePosition.y}),Ve({fillColor:"#00ff1a",squareSize:25}),Re,me(e.followingTarget)({posX:e.relativePosition.x,posY:e.relativePosition.y}),N({isDestroyed:!1}),...r)}function Wn(n,e){return n.spawn(b({posX:e.absolutePosition.x,posY:e.absolutePosition.y}),qe,Ve({fillColor:"#fc0303",squareSize:50}),P({mesh:new Ee(new je(.5,.5,.5),new Y({color:15616811}))}),te,K,ge({thrustVec:0}))}function Yn(n,e){return n.spawn(Lt,K({yVel:-1}),b({posX:e.absolutePosition.x,posY:e.absolutePosition.y}),Ve({fillColor:"#ff9900",squareSize:5}),P({mesh:new Ee(new je(.1,.1,.1),new Y({color:16750848}))}),N({isDestroyed:!1}),U({x:e.absolutePosition.x,y:e.absolutePosition.y,height:5,width:5}))}function zn(n,e,t){const r=n.get(b),s=n.get(K);r.posX>t?(n.set(K,{xVel:s.xVel*-1}),n.set(b,{posY:r.posY+50,posX:t})):r.posX<e&&(n.set(K,{xVel:s.xVel*-1}),n.set(b,{posY:r.posY+50,posX:e}))}function Qn(n){const e=Nn(),t=n.webGlRenderer.getSize(new we),r=qn(e,{absolutePosition:{x:t.width/-2+100,y:t.height/-2+100}}),s=r.get(b);for(let o=0;o<10;o++)for(let c=0;c<5;c++){const a=n.externalResources.spaceInvadersAlien.scene.clone(!0);a.scale.multiplyScalar(1/50),Xn(e,{absolutePosition:{x:s.posX+o*50,y:s.posY+c*50},relativePosition:{x:o*50,y:c*50},followingTarget:r},{model:a})}const i=Wn(e,{absolutePosition:{x:0,y:t.height/2-100}});return{world:e,enemySwarmAnchorEntity:r,playerEntity:i}}function $n(n,e){Bn(n,e),Gn(n,e),n.query(Re,P).forEach(t=>{const{mesh:r}=t.get(P);r.rotation.y+=.01})}function Zn(n,e){const t=Qn(n),r=new AbortController;document.addEventListener("keydown",function(o){}),document.addEventListener("keydown",function(o){switch(o.code){case"ArrowLeft":t.playerEntity.set(te,{dir:"w"});break;case"ArrowRight":t.playerEntity.set(te,{dir:"e"});break;case"KeyV":{const c=t.playerEntity.get(b);Yn(t.world,{absolutePosition:{x:c.posX,y:c.posY}})}break}},{signal:r.signal}),document.addEventListener("keyup",function(o){switch(o.code){case"ArrowLeft":case"ArrowRight":t.playerEntity.set(te,{dir:"none"});break}});function s(){r.abort()}const i={state:t,tick(){const o=n.webGlRenderer.getSize(new we),c=n.getDeltaTime(),a=this.state;zn(a.enemySwarmAnchorEntity,50-o.width/2,200-o.width/2),Hn(a.world,{callbackOnLoseCondition(){s()}}),jn(a.world),On(a.world,{deltaTime:c}),Pn(a.world),Fn(a.world),Un(a.world,{minX:o.width/-2,maxX:o.width/2,minY:o.height/-2,maxY:o.height/2},n),Kn(a.world,n),Vn(a.world),$n(a.world,n)}};return i.tick=i.tick.bind(i),i}const vt=document.getElementById("three-root");if(!vt)throw new Error("Cannot find element root #three-root");Jn(vt);async function Jn(n){const r=new ps,[s]=await Promise.all([new Promise((g,T)=>{r.load(new URL("/blog-assets/recurse-w3d1/space-invaders-demo/models/space-invader-alien/scene.gltf",import.meta.url).href,g,void 0,T)})]),i=new fs,o=new ds,c=new gt(75,800/600,.1,1e3),a=new hs;a.setSize(800,600),n.appendChild(a.domElement),a.setAnimationLoop(m),c.position.z=5;const u=new dt(16777215,3);u.position.set(5,10,5),o.add(u);const l=Zn({camera:c,scene:o,webGlRenderer:a,getDeltaTime:()=>i.getDelta()*1e3,externalResources:{spaceInvadersAlien:s}});let d=!1;document.addEventListener("keydown",function(g){d||g.code==="KeyS"&&(d=!0,o.remove(p))});const f=new je(1,1,1),h=new Y({color:65280}),p=new Ee(f,h);o.add(p);function m(){d?l.tick():(p.rotation.x+=.01,p.rotation.y+=.01),u.position.x+=.01,u.position.y+=.01,u.position.z+=.01,a.render(o,c)}}
